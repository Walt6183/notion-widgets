<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wetter Widget</title>
    
    <!-- iOS Web App Metadata -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-weather.png">
    <meta name="theme-color" content="#3b82f6">

    <!-- Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { background-color: transparent; font-family: sans-serif; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* Animationen fÃ¼r das Overlay */
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 h-screen flex items-center justify-center overflow-hidden">

    <div id="root" class="w-full h-full flex items-center justify-center"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- HIER API KEY EINFÃœGEN ---
        const apiKey = "AIzaSyCBor0L5tEa3B-9bWu0FrIhBaGDKbZL2EA"; 
        // -----------------------------

        // Icons Definitionen
        const Icons = {
            Sun: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>,
            Cloud: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M17.5 19h-11"/><path d="M17.5 19a5.5 5.5 0 0 0 2.625-10.334"/><path d="M6.5 19a5.5 5.5 0 0 1-3.625-9.666"/><path d="M12 13.5V7"/></svg>,
            CloudRain: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></svg>,
            CloudSnow: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M8 15h.01"/><path d="M8 19h.01"/><path d="M12 17h.01"/><path d="M12 21h.01"/><path d="M16 15h.01"/><path d="M16 19h.01"/></svg>,
            CloudLightning: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 16.326A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 .5 8.973"/><path d="m13 12-3 5h4l-3 5"/></svg>,
            CloudFog: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M4 14h16"/><path d="M4 18h16"/><path d="M6.3 8.8a4.3 4.3 0 1 1 11.4 0"/></svg>,
            Droplets: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>,
            Wind: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>,
            MapPin: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>,
            ChevronLeft: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
            Sparkles: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            X: ({className}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>
        };

        const App = () => {
            const [weather, setWeather] = useState(null);
            const [locationName, setLocationName] = useState("Standort suchen...");
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            
            // Scroll State
            const [hourlyOffset, setHourlyOffset] = useState(0);

            // Gemini States
            const [geminiResult, setGeminiResult] = useState(null);
            const [geminiLoading, setGeminiLoading] = useState(false);
            const [showGemini, setShowGemini] = useState(false);

            const getWeatherIcon = (code, className = "") => {
                const props = { className };
                if (code === 0) return { icon: <Icons.Sun {...props} />, label: "Klar" };
                if (code >= 1 && code <= 3) return { icon: <Icons.Cloud {...props} />, label: "BewÃ¶lkt" };
                if (code >= 45 && code <= 48) return { icon: <Icons.CloudFog {...props} />, label: "Nebel" };
                if (code >= 51 && code <= 67) return { icon: <Icons.CloudRain {...props} />, label: "Regen" };
                if (code >= 71 && code <= 77) return { icon: <Icons.CloudSnow {...props} />, label: "Schnee" };
                if (code >= 80 && code <= 99) return { icon: <Icons.CloudRain {...props} />, label: "Gewitter/Regen" };
                return { icon: <Icons.Cloud {...props} />, label: "Unbekannt" };
            };

            const fetchWeather = async (lat, lon) => {
                try {
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&hourly=temperature_2m,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`);
                    const data = await weatherRes.json();
                    
                    try {
                        const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
                        const geoData = await geoRes.json();
                        const city = geoData.address.city || geoData.address.town || geoData.address.village || geoData.address.suburb || "Unbekannt";
                        setLocationName(city);
                    } catch (e) {
                        setLocationName("Standort gefunden");
                    }

                    setWeather(data);
                    setLoading(false);
                } catch (err) {
                    setError("Fehler beim Laden");
                    setLoading(false);
                }
            };

            // Gemini Funktion
            const askGemini = async () => {
                if (!weather) return;
                
                setShowGemini(true);
                setGeminiLoading(true);
                setGeminiResult(null);

                const prompt = `
                Ich bin in ${locationName}. 
                Das Wetter ist aktuell: ${Math.round(weather.current.temperature_2m)} Grad Celsius, 
                Windgeschwindigkeit: ${weather.current.wind_speed_10m} km/h.
                Wettercode (WMO): ${weather.current.weather_code}.
                
                Gib mir als "Wetterfee" einen kurzen, charmanten Absatz (max. 30 WÃ¶rter). 
                Enthalte:
                1. Eine humorvolle Bemerkung zur aktuellen Lage.
                2. Eine konkrete Kleidungsempfehlung (z.B. MÃ¼tze, T-Shirt).
                Antworte auf Deutsch. Nutze Emojis.
                `;

                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                        {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                        }
                    );

                    if (!response.ok) throw new Error(`API Fehler`);

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Die Wetterfee macht gerade Kaffeepause. â˜•";
                    setGeminiResult(text);
                } catch (error) {
                    console.error(error);
                    setGeminiResult("Meine Kristallkugel ist beschlagen. PrÃ¼fe deinen API Key! ðŸ”®");
                } finally {
                    setGeminiLoading(false);
                }
            };

            useEffect(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => fetchWeather(position.coords.latitude, position.coords.longitude),
                        (err) => { fetchWeather(52.52, 13.41); setLocationName("Berlin (Fallback)"); }
                    );
                } else {
                    fetchWeather(52.52, 13.41);
                    setLocationName("Berlin (Fallback)");
                }
            }, []);

            const handlePrevHours = () => setHourlyOffset(prev => Math.max(0, prev - 1));
            const handleNextHours = () => {
                if (weather && (new Date().getHours() + hourlyOffset + 4) < weather.hourly.time.length) {
                    setHourlyOffset(prev => prev + 1);
                }
            };

            const getDayName = (dateStr) => {
                const days = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];
                const d = new Date(dateStr);
                return days[d.getDay()];
            };

            const getHour = (iso) => new Date(iso).getHours() + ":00";

            if (loading) return <div className="flex h-full items-center justify-center text-blue-500 font-sans animate-pulse">Lade Wetter...</div>;

            const current = getWeatherIcon(weather.current.weather_code, "w-12 h-12 text-blue-600");
            
            const currentHourIndex = new Date().getHours();
            const displayStartIndex = currentHourIndex + hourlyOffset;
            const isAtStart = hourlyOffset === 0;
            const isAtEnd = displayStartIndex + 4 >= weather.hourly.time.length;

            return (
                <div className="w-full max-w-sm rounded-3xl overflow-hidden shadow-2xl bg-white font-sans relative ring-1 ring-black/5">
                    
                    {/* Gemini Overlay */}
                    {showGemini && (
                    <div className="absolute inset-0 z-20 flex items-end justify-center bg-black/20 backdrop-blur-[2px]">
                        <div className="m-4 w-full overflow-hidden rounded-2xl bg-white shadow-xl ring-1 ring-black/10 animate-slide-in">
                        <div className="flex items-center justify-between bg-gradient-to-r from-indigo-500 to-purple-600 p-3 text-white">
                            <div className="flex items-center gap-2">
                            <Icons.Sparkles className="h-4 w-4 text-yellow-300" />
                            <span className="font-bold text-sm">KI Wetterfee</span>
                            </div>
                            <button onClick={() => setShowGemini(false)} className="rounded-full p-1 hover:bg-white/20 transition-colors">
                            <Icons.X className="h-4 w-4" />
                            </button>
                        </div>
                        <div className="p-4 text-sm text-slate-700 leading-relaxed min-h-[80px] flex items-center justify-center text-center">
                            {geminiLoading ? (
                            <div className="flex gap-1">
                                <div className="h-2 w-2 rounded-full bg-indigo-400 animate-bounce" style={{animationDelay: '0ms'}}></div>
                                <div className="h-2 w-2 rounded-full bg-purple-400 animate-bounce" style={{animationDelay: '150ms'}}></div>
                                <div className="h-2 w-2 rounded-full bg-pink-400 animate-bounce" style={{animationDelay: '300ms'}}></div>
                            </div>
                            ) : (
                            <p>{geminiResult}</p>
                            )}
                        </div>
                        </div>
                    </div>
                    )}

                    {/* TOP SECTION */}
                    <div className="bg-gradient-to-br from-blue-100 to-blue-200 p-6 relative">
                        
                        {/* KI Button */}
                        <button 
                            onClick={askGemini}
                            className="absolute top-4 right-4 z-10 flex h-8 w-8 items-center justify-center rounded-full bg-white/60 text-indigo-600 shadow-sm backdrop-blur-md transition-all hover:bg-white hover:scale-110 hover:shadow-md"
                        >
                            <Icons.Sparkles className="h-4 w-4" />
                        </button>

                        <div className="flex justify-between items-start pr-10">
                            <div className="flex items-center space-x-1 text-slate-700">
                                <Icons.MapPin className="w-5 h-5"/>
                                <span className="font-bold text-lg tracking-tight">{locationName}</span>
                            </div>
                            <div className="flex flex-col items-end">
                                <span className="text-sm font-medium text-slate-600 mb-1">{current.label}</span>
                                {current.icon}
                            </div>
                        </div>

                        <div className="mt-3 text-6xl font-light tracking-tighter text-slate-800 drop-shadow-sm">
                            {Math.round(weather.current.temperature_2m)}Â°
                        </div>

                        <div className="flex space-x-3 mt-6">
                            <div className="flex items-center space-x-2 bg-slate-800/80 text-white px-3 py-1.5 rounded-full text-xs font-medium backdrop-blur-sm shadow-sm">
                                <Icons.Droplets className="w-3 h-3"/>
                                <span>{weather.current.relative_humidity_2m}%</span>
                            </div>
                            <div className="flex items-center space-x-2 bg-slate-800/80 text-white px-3 py-1.5 rounded-full text-xs font-medium backdrop-blur-sm shadow-sm">
                                <Icons.Wind className="w-3 h-3"/>
                                <span>{weather.current.wind_speed_10m} km/h</span>
                            </div>
                        </div>

                        {/* Hourly simple view with scrolling */}
                        <div className="flex justify-between items-center mt-8 px-1">
                             <button 
                                onClick={handlePrevHours}
                                disabled={isAtStart}
                                className={`p-1 rounded-full transition-colors ${isAtStart ? 'text-slate-300 cursor-not-allowed' : 'text-slate-600 hover:bg-white/40'}`}
                            >
                                <Icons.ChevronLeft className="w-6 h-6"/>
                            </button>

                            {weather.hourly.time.slice(displayStartIndex, displayStartIndex + 4).map((t, i) => {
                                const idx = displayStartIndex + i;
                                const code = weather.hourly.weather_code[idx];
                                const temp = weather.hourly.temperature_2m[idx];
                                return (
                                    <div key={t} className="flex flex-col items-center space-y-2 cursor-default transition-transform hover:scale-105">
                                        <span className="text-[10px] font-bold text-slate-400">{getHour(t)}</span>
                                        {getWeatherIcon(code, "w-6 h-6 text-slate-600").icon}
                                        <span className="text-sm font-bold text-slate-700">{Math.round(temp)}Â°</span>
                                    </div>
                                )
                            })}

                            <button 
                                onClick={handleNextHours}
                                disabled={isAtEnd}
                                className={`p-1 rounded-full transition-colors ${isAtEnd ? 'text-slate-300 cursor-not-allowed' : 'text-slate-600 hover:bg-white/40'}`}
                            >
                                <Icons.ChevronRight className="w-6 h-6"/>
                            </button>
                        </div>
                    </div>

                    {/* BOTTOM SECTION */}
                    <div className="bg-slate-800 p-6 text-white">
                        <div className="flex flex-col space-y-4">
                            {weather.daily.time.slice(0, 5).map((d, i) => {
                                const code = weather.daily.weather_code[i];
                                const max = weather.daily.temperature_2m_max[i];
                                const min = weather.daily.temperature_2m_min[i];
                                return (
                                    <div key={d} className="flex items-center justify-between group">
                                        <span className="w-24 font-medium text-sm text-slate-200 group-hover:text-white transition-colors">{i === 0 ? "Heute" : getDayName(d)}</span>
                                        <div className="flex-1 flex justify-center opacity-80 group-hover:opacity-100 transition-opacity">
                                            {getWeatherIcon(code, "w-5 h-5 text-slate-300").icon}
                                        </div>
                                        <div className="w-20 flex justify-end space-x-3 text-sm">
                                            <span className="font-bold">{Math.round(max)}Â°</span>
                                            <span className="text-slate-500 group-hover:text-slate-400 transition-colors">{Math.round(min)}Â°</span>
                                        </div>
                                    </div>
                                )
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
